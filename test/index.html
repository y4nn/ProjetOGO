
<!DOCTYPE HTML>

<html lang="fr" manifest="mgeoadmin.appcache">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta name="Content-Language" content="fr"/>
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0">
        <meta name="apple-mobile-web-app-capable" content="yes">

            <title>GeoAdmin Mobile Application</title>

        <link rel="apple-touch-icon" href="/main/wsgi/6bf96/app/images/logo.png"/>
        <link rel="shortcut icon" type="image/x-icon" href="/main/wsgi/6bf96/app/images/favicon.ico"/>
        <link rel="icon" type="image/x-icon" href="/main/wsgi/6bf96/app/images/favicon.ico"/>
        <link rel="apple-touch-startup-image" href="/main/wsgi/6bf96/app/images/logo.png">
        <link rel="apple-touch-icon-precomposed" href="/main/wsgi/6bf96/app/images/logo.png"/>

        <link rel="stylesheet" type="text/css" href="/main/wsgi/6bf96/build/geoadmin.css"/>

        <script type="text/javascript">
    (function(){
        function getBackUrl(){
            // Try to parse back_url parameter from URI
            var parameters = location.href.replace(/^[^#?]+/, '').split(/[?#&]/);
            for(var i=0; i<parameters.length; i++){
                var pair = parameters[i].split('=');
                if(pair.length===2 && pair[0]==='back_url'){
                    return decodeURIComponent(pair[1]);
                }
            }
            return undefined;
        }
        var referrerParser = document.createElement('a');
        referrerParser.href = getBackUrl() ||  document.referrer;
        if(referrerParser.hostname!==location.hostname || document.referrer===''){
            // Save referrer for going back to back application because value will get lost due to redirects
            try {
                localStorage.referrer = getBackUrl() || document.referrer;
            } catch (e) {};
        }
    })();
    function getParams(query) {
            var params = {};
            var e, a = /\+/g, r = /([^&=]+)=?([^&]*)/g;
            var d = function (s) { return decodeURIComponent(s.replace(a, " ")); };
            while (e = r.exec(query))
                params[d(e[1])] = d(e[2]);
            return params;
     }
     function getQueryString(params) {
            var paramsArray = [];
            for (var key in params) {
                var value = params[key];
                if (value != null) {
                    var encodedValue = encodeURIComponent(value);
                    paramsArray.push(encodeURIComponent(key) + "=" + encodedValue);
                }
            }
            return paramsArray.join("&");
        }
    
        var hash, search;
        var isWebKit = true;
        var isMobile = false;
        var redirect_to = "";
        var desktopUrl = redirect_to;
        var query_string = "mobile=true";
        if (redirect_to) {
              // Do magic rewrite mobile --> desktop
              var params = {};
              var newsearch = window.location.hash.match(/#?(.*)/)[1];
              if (newsearch != '') {
                  params = getParams(newsearch);
                  var bgOpacity = 1.0;
                  if (params.bgOpacity) {
                    bgOpacity = parseFloat(params.bgOpacity);
                  }
                  bgOpacity = (bgOpacity >=0 && bgOpacity <= 1.0) ? bgOpacity : undefined;
                  var bgLayer = params.bgLayer;
                  if (bgLayer == undefined) {
                      bgLayer = 'voidLayer';
                      bgOpacity = 1;
                  }
                  if (bgLayer =='ch.swisstopo.swissimage' && bgOpacity >= 1.0)
                      bgOpacity = 0;

                  params.bgOpacity = bgOpacity;
                  params.bgLayer = bgLayer;
              }              
              // avoid infinite loops
              params.mobile = 'false';

              window.location = redirect_to + "?" + getQueryString(params);
        }
         
       // Do the magic transformation desktop-->mobile
        var params = getParams(window.location.search.substring(1));
        if (params.bgLayer) {
            var bgOpacity = 1.0;
            if (params.bgOpacity) {
                bgOpacity = parseFloat(params.bgOpacity);
            }
            bgOpacity = (bgOpacity >=0 && bgOpacity <= 1.0) ? bgOpacity : 0;
            var bgLayer = params.bgLayer;
            switch (bgLayer) {
            case 'ch.swisstopo.pixelkarte-farbe':
                bgLayer =  (bgOpacity >= 0.5) ? 'ch.swisstopo.pixelkarte-farbe' : 'ch.swisstopo.swissimage';
                bgOpacity = 1.0;
                break;
            case 'ch.swisstopo.pixelkarte-grau':
                bgLayer =  (bgOpacity >= 0.5) ? 'ch.swisstopo.pixelkarte-grau' : 'ch.swisstopo.swissimage';
                bgOpacity = 1.0;
                break;
            case 'ch.kantone.hintergrund-farbe':
                bgLayer =  (bgOpacity >= 0.5) ? 'ch.kantone.hintergrund-farbe' : 'ch.swisstopo.swissimage';
                bgOpacity = 1.0;
                break;
            case 'ch.swisstopo.tml3d-hintergrund-karte':
                bgLayer =  (bgOpacity >= 0.5) ? 'ch.swisstopo.tml3d-hintergrund-karte' : 'ch.swisstopo.swissimage';
                bgOpacity = 1.0;
                break;
            case 'voidLayer':
                bgLayer =  (bgOpacity >= 0.5) ? null : 'ch.swisstopo.swissimage';
                bgOpacity =  (bgOpacity >= 0.5) ? null : bgOpacity;
                break;
            default:
                bgLayer = 'ch.swisstopo.pixelkarte-farbe';
                 bgOpacity = 1.0;
            }
            params.bgOpacity = bgOpacity;
            params.bgLayer = bgLayer;
       }
       if (params.layers && !params.layers_opacity) {
           var opacities = [] ;
           for (var i = o; i <= params.layers.length; i++) {
               opacities.push(1);
           }
           params.layers_opacity = opacities.join(",");
       }
       if (!params.lang) {
           params.lang = "fr";
       }
       
       //var project_type = "geoadmin";
       project_type = params.project; 
       var query_string =  window.location.search.match(/\??(.*)/)[1];
       // do the magic only if coming with desktop permalink
       if (window.location.hash =='')
           window.location.hash =  getQueryString(params); 
           var search = '';
           if (params.mobile) {
               search = 'mobile=' + params.mobile;
           }
           if (params.debug) {
               search += '&debug=' + params.debug;
           }
           if (project_type) {
              search += '&project=' + project_type;
           }
           if (params.topic) {
               search+= '&topic=' + params.topic;
           }

           window.location.search = search;

        </script>
        <script type="text/javascript">
        if(!window.GeoAdminMobileApp){
            window.GeoAdminMobileApp = {};
        }
        //GeoAdminMobileApp.project = 'geoadmin';
        GeoAdminMobileApp.project = project_type; 
        GeoAdminMobileApp.topic = params.topic;
        </script>

        <script type="text/javascript" src="/main/wsgi/6bf96/build/geoadmin.js"></script>

        <!-- <script type="text/javascript" src="/main/wsgi/build/lang-fr.js"></script> -->

    </head>
    <body class="geoadmin">
    </body>
</html>
